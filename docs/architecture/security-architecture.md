# JustMemo 安全与隐私架构 (Security & Privacy)

> 最后更新：2026-02-21 (新增：私密记录元数据脱敏与差异化可见性控制)

## 1. 隐私策略
*   物理隔离方案: 采用服务端 Supabase RPC 校验方案，确保未授权内容物理级不返回。
*   搜索隔离: 私密内容对非授权用户在搜索模式下彻底隐身（不返回占位符）。
*   可见性控制: 默认 Public，支持 `is_private` 标记。
*   差异化可见性控制:
    *   **主 Feed (Home)**: 允许未登录用户看到私密记录的锁定占位符。
    *   **归档与相册 (Archived/Gallery)**: 对未登录用户严格隐藏所有私密内容，避免任何信息泄露。

## 2. 解锁流程 (Unlock Flow)
1.  视觉屏蔽: 锁定内容通过 高斯模糊 (Gaussian Blur) 针对“占位文本”进行渲染，并展示 口令提示词 (Hint)。
2.  验证机制: 采用 Server Action + HttpOnly Cookie 实现 Hash 校验。
3. 会话保持与离线: 用户输入密码成功后，写入加密 Cookie。系统支持在 Session 内缓存已解密内容，确保用户在联网解锁后，短时间内离线仍可阅读已解锁的记录。

## 3. 操作安全 (Operations Safety)
*   二次确认机制: 当管理员尝试将私密记录转为公开发布时，系统弹出 Dialog 进行强制确认，防止因误操作导致敏感信息泄露。

## 4. 鉴权逻辑 (Authentication)
*   管理员: 使用 Supabase Auth (Email/Login) 管理发布、编辑与删除权限。前端通过 `UserContext` 维护全局 `isAdmin` 状态，实现极致的 UI 响应性能，避免重复的 Server Action 调用。
*   写操作保护: 开启数据库 RLS (Row Level Security)，物理级限制 `UPDATE` 和 `DELETE` 操作仅限认证的管理员。
*   访客: 基于 RPC 函数的口令匹配获取内容。在非搜索模式下仅能看到加密占位。
*   脱敏同步 (Redacted Sync): 全量后台同步接口 (`getAllMemos`) 或 RPC 对私密记录执行物理级元数据脱敏：
    *   **正文内容 & 标签**: 锁定状态下置空。
    *   **字数统计**: 置为 `0` (数据库 RPC 层) 或显示为 `*` (前端 UI 层)。
    *   **时间戳**: 前端将具体时分脱敏为 `**:**`，仅保留日期（例如 `2026-02-20 **:**`）以兼顾感官与排序。
