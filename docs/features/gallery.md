# 画廊 · 卡片式相册 (Gallery)

> 最后更新日期：2026-02-24
> 状态：设计讨论中，尚未进入实现

## 功能概述
将画廊页面重构为**纯图片沉浸式瀑布流**体验。每个卡片代表一条含图片的 Memo，采用"首图封面 + 多图切换"的交互模式，同时提供溯源能力（弹出原始 Memo 详情对话框）。

## 设计目标
1. **纯图片视觉**：画廊只展示图片，去除悬浮文字遮罩，聚焦视觉沉浸感。
2. **多图支持**：一条 Memo 包含多张图片时，卡片显示首图封面 + 右上角多图指示器（如 `1/3`），点击后可在全屏 Lightbox 中左右切换。
3. **溯源详情**：全屏大图视图中提供"溯源"按钮，点击后弹出独立对话框，复用首页 `MemoCard` 样式展示该 Memo 的完整内容（文字、标签、时间等），无需离开画廊页。
4. **极速体验**：优先复用全局 `memoCache` 缓存数据，前端过滤出含图片的 Memo，实现秒开。

## 数据策略

### 核心思路：复用全局缓存 + 前端过滤
项目已有全量数据加载机制（详见 [数据获取架构讨论](../architecture/data-fetching-strategy.md)），画廊页面直接复用该全局缓存：

1. **缓存命中**（正常 SPA 切换）：从 `memoCache` 单例读取全量 Memo → 前端正则过滤含 `![...](...)` 的记录 → **秒开**。
2. **缓存未命中**（首次直接访问 `/gallery`）：组件自行触发 `getAllMemos()` 加载全量数据到 `memoCache` → 过滤 → 展示。此操作同时为其他页面做了缓存预热。
3. **后台刷新**：通过 `memoCache.subscribe()` 机制，当其他页面触发数据更新时，画廊自动获得最新数据。

### 原有的独立接口 `getGalleryMemos`
该接口通过 `.ilike('content', '%![%](%)%')` 在数据库层筛选。在全局缓存策略下，该接口可被废弃，由前端过滤替代。

## 交互细节

### 卡片视觉
| 元素 | 说明 |
|------|------|
| 封面图 | 始终展示 `imageUrls[0]` |
| 多图标记 | `imageUrls.length > 1` 时右上角显示数量指示器 |
| Hover 效果 | 轻微图片放大 + 边框提亮，**不再显示文字遮罩** |
| 月份分组 | 按"年月"分组，保留分隔线和计数标签 |

### 图片提取逻辑
```
// 现有：仅提取第一张
/!\[.*?\]\((.*?)\)/

// 重构：提取全部图片
/!\[.*?\]\((.*?)\)/g
```

### 点击放大 (Lightbox)
- 单图 Memo：点击直接放大（可复用或增强现有 `ImageZoom`）。
- 多图 Memo：进入轻量级全屏 Lightbox，支持左右切换箭头导航。
- Lightbox 只在点击时渲染（Lazy Mount），不影响首屏性能。

### 溯源对话框
- 在 Lightbox 视图角落提供溯源按钮（链接图标）。
- 点击后**弹出居中 Dialog Modal**，内部复用 `MemoCard.tsx` 的标准样式。
- 对话框内支持滚动（长文本/多评论场景）。

## 涉及文件
| 文件 | 改动类型 |
|------|----------|
| `src/components/gallery/GalleryGrid.tsx` | 重构：多图提取、卡片视觉、Hover 清理 |
| `src/components/pages/GalleryPageContent.tsx` | 修改：数据源切换为 `memoCache` |
| `src/components/gallery/GalleryLightbox.tsx` | 新增：全屏多图浏览 + 溯源按钮 |
| `src/components/gallery/MemoDetailDialog.tsx` | 新增：溯源详情对话框 |
| `src/actions/fetchMemos.ts` | 待定：`getGalleryMemos` 可能废弃 |

## 验证计划
1. 画廊仅展示包含图片的 Memos，且使用缓存数据秒开。
2. 多图 Memos 显示正确的数量标记。
3. 单图点击放大正常；多图点击进 Lightbox 可切换。
4. 溯源按钮弹出的 Dialog 样式与首页 MemoCard 一致。
