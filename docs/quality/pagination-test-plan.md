# 分页重构测试方案 (Pagination Testing Plan)

> 最后更新日期：2026-02-24
> 目标：确保分页重构过程中系统的稳定性，特别是用户体验的零退化。

## 1. 测试策略：TDD 与 BDD 的整合

本重构采用 **BDD (行为驱动) 为主，TDD (测试驱动) 为辅** 的策略。

### BDD (端到端测试 / Playwright)
**目的**：确保在"内部实现从全量变为分页"后，用户看到的系统行为保持 100% 一致。
**关注点**：组件交互、DOM 表现、API 联动。

### TDD (单元测试 / Vitest)
**目的**：验证底层原子函数的边界情况。
**关注点**：复杂的游标计算、合并去重算法、缓存容量限制处理。

---

## 2. 核心测试场景 (BDD Case)

### 场景 A：首页无限滚动分页 (Phase 2)
*   **Given**: 数据库中有 50 条记录。
*   **When**: 首次进入首页。
*   **Then**: 页面只显示前 20 条，底部显示加载状态或哨兵。
*   **When**: 滚动触底。
*   **Then**: 追加加载后 20 条，页面总数变为 40。
*   **When**: 切换标签过滤。
*   **Then**: 列表重置，只显示该标签的前 20 条（带分页）。

### 场景 B：@ 引用双路径并行搜索 (Phase 1)
*   **Given**: `localStorage` 缓存了旧的轻量索引。
*   **When**: 编辑器输入 `@`。
*   **Then**: 立刻显示本地索引匹配的结果。
*   **When**: 等待约 300ms（模拟网络延迟）。
*   **Then**: 列表追加远程搜索返回的匹配结果，且无重复项。

### 场景 C：画廊瀑布流无限滚动 (Phase 3)
*   **Given**: 用户访问 `/gallery`。
*   **When**: 首次加载。
*   **Then**: 瀑布流渲染前 N 张图片。
*   **When**: 向下滚动。
*   **Then**: 持续加载后续图片，不出现布局抖动。

---

## 3. 核心测试项 (TDD Case)

### `src/lib/memo-cache.ts`
- [ ] **索引合并**：测试 `mergeIndexItems` 在处理乱序游标时能否维持时间倒序排列。
- [ ] **去重逻辑**：确保后端返回的数据与本地缓存索引合并时，不会出现重复条目。
- [ ] **容量策略**：测试 `localStorage` 接近满标时，是否能按策略溢出或提示错误。

### `src/actions/fetchMemos.ts` (RPC Wrapper)
- [ ] **游标偏移**：测试 `cursor` 参数在各种时间格式下的解析准确性。
- [ ] **空数据处理**：测试当 `cursor` 已经位于数据库最后一条记录后，能否正确返回空数组而非报错。

---

## 4. 自动化回归流程

1.  **重构前**：运行现有 `e2e/core.spec.ts` 确保基准功能正常。
2.  **开发阶段**：针对改动的函数编写单元测试 (`.test.ts`)。
3.  **提交前**：在本地运行全量 BDD 测试集 (`npx playwright test`)，确保重构没有破坏用户可见的功能。
4.  **验证标准**：所有 BDD 测试必须保持 `Green` 状态。
